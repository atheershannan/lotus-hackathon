name: build-test-deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      INTERNAL_PORT: 3000
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_ENV_COORDINATOR: ${{ secrets.RAILWAY_ENV_COORDINATOR }}
      RAILWAY_ENV_MS1: ${{ secrets.RAILWAY_ENV_MS1 }}
      RAILWAY_ENV_MS2: ${{ secrets.RAILWAY_ENV_MS2 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Use Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Build, Test & Deploy Services
        run: |
          set -e
          PORT_COUNTER=3000
          for service_path in services/*; do
            if [ ! -d "$service_path" ]; then
              continue
            fi
            service=$(basename "$service_path")
            echo "=============================="
            echo "Processing service: $service"
            echo "=============================="
            docker build -t "$service:latest" "$service_path"
            docker run -d -p $PORT_COUNTER:$INTERNAL_PORT --name "${service}_test" "$service:latest"
            sleep 10
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$PORT_COUNTER/health" || echo "000")
            REGISTER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$PORT_COUNTER/register" || echo "000")
            if [ "$STATUS" -ne 200 ]; then
              echo "âŒ $service /health FAILED ($STATUS)"
              docker logs "${service}_test" || true
              docker rm -f "${service}_test" || true
              exit 1
            fi
            if [ "$REGISTER_STATUS" -lt 200 ] || [ "$REGISTER_STATUS" -ge 300 ]; then
              echo "âŒ $service /register FAILED ($REGISTER_STATUS)"
              docker logs "${service}_test" || true
              docker rm -f "${service}_test" || true
              exit 1
            fi
            echo "âœ… $service local smoke tests PASSED"
            docker rm -f "${service}_test" || true
            ENV_VAR_NAME="RAILWAY_ENV_${service^^}"
            ENV_ID=$(printenv "$ENV_VAR_NAME")
            if [ -z "$ENV_ID" ]; then
              echo "âš ï¸ No Railway env ID for $service (expected $ENV_VAR_NAME)"
              continue
            fi
            echo "ðŸš€ Deploying $service â†’ Railway (env: $ENV_ID)"
            cd "$service_path"
            railway up --service "$service" --environment "$ENV_ID" --ci
            cd - > /dev/null
            echo "ðŸ” Running post-deploy tests in Railway..."
            cd "$service_path"
            railway run -- bash -lc '
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/health" || echo "000")
              REGISTER=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/register" || echo "000")
              if [ "$STATUS" -ne 200 ] || [ "$REGISTER" -lt 200 ] || [ "$REGISTER" -ge 300 ]; then
                echo "âŒ Post-deploy smoke tests FAILED"
                exit 1
              fi
              echo "âœ… Post-deploy smoke tests PASSED"
            '
            cd - > /dev/null
            PORT_COUNTER=$((PORT_COUNTER + 1))
          done

